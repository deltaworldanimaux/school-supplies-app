<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <title>ŸÑŸàÿ≠ÿ© ÿ™ÿ≠ŸÉŸÖ ŸÖÿØÿ±ÿ≥ÿ™Ÿä - ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™</title>
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #FF9800;
            --accent: #2196F3;
            --light: #F5F5F5;
            --dark: #333;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7f9;
            padding: 20px;
            position: relative;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: bold;
        }
        
        .auth-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .admin-content {
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        .filters {
    margin-bottom: 20px;
    display: flex;
    gap: 15px;
    align-items: center;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    flex-wrap: wrap;
}

.filters select,
.filters input[type="text"] {
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    min-width: 180px;
    background: white;
    transition: border-color 0.3s, box-shadow 0.3s;
}

.filters select:focus,
.filters input[type="text"]:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
}

.filters input[type="text"]::placeholder {
    color: #999;
}

.filters button {
    background: var(--primary);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 500;
}

.filters button:hover {
    background: #3d8b40;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.filters button:active {
    transform: translateY(0);
}

/* Responsive design for filters */
@media (max-width: 768px) {
    .filters {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
    }
    
    .filters select,
    .filters input[type="text"],
    .filters button {
        width: 100%;
        min-width: unset;
    }
}

/* Filter label styling (if you want to add labels) */
.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-label {
    font-size: 12px;
    font-weight: 600;
    color: #666;
    margin-bottom: 5px;
}

/* Enhanced select styling */
.filters select {
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: left 12px center;
    background-size: 16px;
    padding-left: 40px;
}

/* For RTL layout */
[dir="rtl"] .filters select {
    background-position: right 12px center;
    padding-left: 15px;
    padding-right: 40px;
}

/* Search input with icon */
.search-container {
    position: relative;
    display: flex;
    align-items: center;
}

.search-container::before {
    content: "üîç";
    position: absolute;
    right: 12px;
    color: #999;
    pointer-events: none;
    z-index: 1;
}

[dir="rtl"] .search-container::before {
    right: auto;
    left: 12px;
}

/* Clear filters button (optional) */
.clear-filters-btn {
    background: #6c757d !important;
    color: white;
    font-size: 13px;
    padding: 8px 15px;
}

.clear-filters-btn:hover {
    background: #5a6268 !important;
}
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .orders-table th, .orders-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        
        .orders-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        .orders-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-confirmed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-processing {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .status-delivered {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-select {
            padding: 6px 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background: white;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 0.8rem;
        }
        
        .view-btn {
            background-color: var(--accent);
            color: white;
        }
        
        .delete-btn {
            background-color: #dc3545;
            color: white;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            position: relative;
            z-index: 2;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }
        
        .login-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            display: block;
            width: 100%;
            font-weight: bold;
        }
        
        .login-btn:hover {
            background: #3d8b40;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .hidden {
            display: none;
        }
        
        .order-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .order-details-modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 15px;
        }
        
        .detail-label {
            font-weight: 600;
            width: 150px;
            color: #666;
        }
        
        .detail-value {
            flex: 1;
        }
        
        .file-link {
            color: var(--accent);
            text-decoration: none;
            display: inline-block;
            margin-right: 10px;
        }
        
        .file-link:hover {
            text-decoration: underline;
        }
        
        .file-preview {
            max-width: 100%;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
        }
        
        .file-preview img {
            max-width: 100%;
            max-height: 300px;
            display: block;
        }
        
        .map-link {
            color: var(--accent);
            text-decoration: none;
            display: inline-block;
            margin-top: 10px;
        }
        
        .map-link:hover {
            text-decoration: underline;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #666;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .image-preview-container {
            margin-top: 10px;
            max-width: 100%;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-container">
        <h2 style="text-align: center; margin-bottom: 30px;">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ•ŸÑŸâ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ</h2>
        <div id="loginAlert" class="alert hidden"></div>
        <div class="form-group">
            <label for="adminUsername">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</label>
            <input type="text" id="adminUsername" required>
        </div>
        <div class="form-group">
            <label for="adminPassword">ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label>
            <input type="password" id="adminPassword" required>
        </div>
        <button id="adminLoginBtn" class="login-btn">ÿØÿÆŸàŸÑ</button>
    </div>

    <div id="adminPage" class="container hidden">
        <header>
    <div class="logo">
        <span>üìä ŸÑŸàÿ≠ÿ© ÿ™ÿ≠ŸÉŸÖ ŸÖÿØÿ±ÿ≥ÿ™Ÿä</span>
    </div>
    <div class="auth-info">
        <span>ŸÖÿ±ÿ≠ÿ®ÿßŸã, <span id="adminName">Admin</span></span>
        <button id="manageLibrariesBtn" class="btn" style="margin-left: 10px;">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÉÿ™ÿ®ÿßÿ™</button>
        <button id="logoutBtn" class="btn">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</button>
    </div>
</header>

        <div class="admin-content">
            <h1>ÿ•ÿØÿßÿ±ÿ© ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÑŸàÿßÿ≤ŸÖ ÿßŸÑŸÖÿØÿ±ÿ≥Ÿäÿ©</h1>
            
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™</div>
                    <div class="stat-number" id="totalOrders">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ÿ∑ŸÑÿ®ÿßÿ™ ŸÇŸäÿØ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©</div>
                    <div class="stat-number" id="pendingOrders">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ÿ∑ŸÑÿ®ÿßÿ™ ÿ™ŸÖ ÿ™ÿ£ŸÉŸäÿØŸáÿß</div>
                    <div class="stat-number" id="confirmedOrders">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ÿ∑ŸÑÿ®ÿßÿ™ ÿ™ŸÖ ÿ™ŸàÿµŸäŸÑŸáÿß</div>
                    <div class="stat-number" id="deliveredOrders">0</div>
                </div>
            </div>
<div class="filters" style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
    <select id="statusFilter">
        <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ÿßŸÑÿßÿ™</option>
        <option value="pending">ŸÇŸäÿØ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©</option>
        <option value="confirmed">ÿ™ŸÖ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ</option>
        <option value="processing">ŸÇŸäÿØ ÿßŸÑÿ™ÿ¨ŸáŸäÿ≤</option>
        <option value="delivered">ÿ™ŸÖ ÿßŸÑÿ™ŸàÿµŸäŸÑ</option>
    </select>
    <input type="text" id="searchInput" placeholder="ÿ®ÿ≠ÿ´ ÿ®ÿßÿ≥ŸÖ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ± ÿ£Ÿà ÿßŸÑÿ™ŸÑŸÖŸäÿ∞">
    <button id="applyFilters">ÿ™ÿ∑ÿ®ŸäŸÇ</button>
</div>
            <div id="ordersAlert" class="alert hidden"></div>
            
            <div id="ordersLoading" class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™...</div>
            
            <table class="orders-table">
                <thead>
                    <tr>
                        <th>ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®</th>
                        <th>ÿßÿ≥ŸÖ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±</th>
                        <th>ÿßÿ≥ŸÖ ÿßŸÑÿ™ŸÑŸÖŸäÿ∞</th>
                        <th>ÿßŸÑŸáÿßÿ™ŸÅ</th>
                        <th>ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿØÿ±ÿßÿ≥Ÿä</th>
                        <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                        <th>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                        <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <!-- Orders will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Modal placed inside admin page so it's hidden when admin page is hidden -->
        <div id="orderDetailsModal" class="order-details-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ∑ŸÑÿ®</h2>
                    <button class="close-btn" id="closeModalBtn">&times;</button>
                </div>
                <div id="orderDetailsContent">
                    <!-- Order details will be populated here -->
                </div>
                <div class="action-buttons">
                    <button class="action-btn view-btn" id="viewImageBtn">ÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ±ÿ©</button>
                    <button class="action-btn view-btn" id="viewLocationBtn">ÿπÿ±ÿ∂ ÿßŸÑŸÖŸàŸÇÿπ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©</button>
                </div>
                <div class="image-preview-container">
                    <img id="imagePreview" class="image-preview" style="display: none;" />
                </div>
            </div>
        </div>
    </div>
<div id="libraryModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 10px;">
    
    <div id="map" style="height: 300px; margin-bottom: 15px; border: 1px solid #ddd;"></div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
      <div>
        <label>ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÉÿ™ÿ®ÿ©:</label>
        <input type="text" id="libraryName" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
      </div>
      <div>
        <label>Ÿáÿßÿ™ŸÅ ÿßŸÑŸÖŸÉÿ™ÿ®ÿ©:</label>
        <input type="text" id="libraryPhone" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
      </div>
      <div>
        <label>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:</label>
        <input type="text" id="libraryUsername" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
      </div>
      <div>
        <label>ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±:</label>
        <input type="password" id="libraryPassword" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
      </div>
    </div>
    
    <button id="saveLibraryBtn" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
      ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÉÿ™ÿ®ÿ©
    </button>
    
    <div id="librariesList" style="margin-top: 20px;">
      <h3>ÿßŸÑŸÖŸÉÿ™ÿ®ÿßÿ™ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©</h3>
      <div id="librariesContainer"></div>
    </div>
  </div>
</div>

<!-- Assign Order Modal -->
<div id="assignOrderModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 10px;">
    <span class="close" style="color: #aaa; float: left; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
    <h2>ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ∑ŸÑÿ® ÿ•ŸÑŸâ ŸÖŸÉÿ™ÿ®ÿ©</h2>
    <p>ÿßŸÑÿ∑ŸÑÿ®: <span id="assignOrderNumber"></span></p>
    
    <div id="librariesListForAssign" style="margin-top: 20px;">
      <h3>ÿßÿÆÿ™ÿ± ŸÖŸÉÿ™ÿ®ÿ©:</h3>
      <div id="librariesForAssignContainer"></div>
    </div>
  </div>
</div>
    <script>
        let authToken = localStorage.getItem('adminToken');
        const API_BASE = window.location.origin;
        let currentOrder = null;
        
        // Check if user is already logged in
        if (authToken) {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminPage').classList.remove('hidden');
            loadOrders();
        } else {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('adminPage').classList.add('hidden');
        }
        
        // Login functionality
        document.getElementById('adminLoginBtn').addEventListener('click', function() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            if (!username || !password) {
                showAlert('loginAlert', 'error', 'Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ');
                return;
            }
            
            fetch(`${API_BASE}/api/admin/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({username, password})
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.token) {
                    localStorage.setItem('adminToken', data.token);
                    authToken = data.token;
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('adminPage').classList.remove('hidden');
                    document.getElementById('adminName').textContent = data.admin.username;
                    loadOrders();
                    setupEventSource();

                } else {
                    showAlert('loginAlert', 'error', data.message || 'ŸÅÿ¥ŸÑ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ');
                }
            })
            .catch(error => {
                showAlert('loginAlert', 'error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ');
                console.error('Login error:', error);
            });
        });
        
        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('adminToken');
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('orderDetailsModal').classList.remove('active');
        });
        
        // Load orders from server
        function loadOrders() {
            document.getElementById('ordersLoading').classList.remove('hidden');
            
            fetch(`${API_BASE}/api/orders`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            })
            .then(response => {
                if (response.status === 401) {
                    // Token expired or invalid
                    localStorage.removeItem('adminToken');
                    document.getElementById('loginPage').classList.remove('hidden');
                    document.getElementById('adminPage').classList.add('hidden');
                    showAlert('loginAlert', 'error', 'ÿßŸÜÿ™Ÿáÿ™ ÿ¨ŸÑÿ≥ÿ© ÿßŸÑÿπŸÖŸÑÿå Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ');
                    return Promise.reject('Unauthorized');
                }
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(orders => {
    document.getElementById('ordersLoading').classList.add('hidden');
    allOrders = orders;
    applyFilters(); // Apply initial filters
})
            .catch(error => {
                document.getElementById('ordersLoading').classList.add('hidden');
                if (error !== 'Unauthorized') {
                    showAlert('ordersAlert', 'error', 'ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™');
                    console.error('Error loading orders:', error);
                }
            });
        }
        
        // Update statistics
        function updateStats(orders) {
    const totalOrdersEl = document.getElementById('totalOrders');
    const pendingOrdersEl = document.getElementById('pendingOrders');
    const confirmedOrdersEl = document.getElementById('confirmedOrders');
    const deliveredOrdersEl = document.getElementById('deliveredOrders');
    
    if (totalOrdersEl) totalOrdersEl.textContent = orders.length;
    if (pendingOrdersEl) pendingOrdersEl.textContent = orders.filter(o => o.status === 'pending').length;
    if (confirmedOrdersEl) confirmedOrdersEl.textContent = orders.filter(o => o.status === 'confirmed').length;
    if (deliveredOrdersEl) deliveredOrdersEl.textContent = orders.filter(o => o.status === 'delivered').length;
}

function setupEventSource() {
  const eventSource = new EventSource(`${API_BASE}/api/orders/events`, {
    headers: {
      'Authorization': `Bearer ${authToken}`
    }
  });

  eventSource.addEventListener('new-order', function(event) {
    const data = JSON.parse(event.data);
    showAlert('ordersAlert', 'success', `New order received: ${data.orderNumber}`);
    loadOrders(); // Refresh the orders list
  });

  eventSource.onerror = function(err) {
    console.error('EventSource failed:', err);
    // Try to reconnect after 5 seconds
    setTimeout(setupEventSource, 5000);
  };
}
        // Render orders table
        function renderOrdersTable(orders) {
            const tbody = document.getElementById('ordersTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™</td></tr>';
                return;
            }
            
            orders.forEach(order => {
                const tr = document.createElement('tr');
                
                // Format date
                const orderDate = new Date(order.createdAt).toLocaleDateString('ar-MA');
                
                tr.innerHTML = `
  <td>${order.orderNumber || order._id || 'N/A'}</td>
  <td>${order.parentName || 'ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'}</td>
  <td>${order.studentName || 'ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'}</td>
  <td>${order.phone || 'ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'}</td>
  <td>${order.grade || 'ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'}</td>
  <td>
    <select class="status-select" data-order="${order._id || order.id}">
      <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>ŸÇŸäÿØ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©</option>
      <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>ÿ™ŸÖ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ</option>
      <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>ŸÇŸäÿØ ÿßŸÑÿ™ÿ¨ŸáŸäÿ≤</option>
      <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>ÿ™ŸÖ ÿßŸÑÿ™ŸàÿµŸäŸÑ</option>
    </select>
  </td>
  <td>${orderDate}</td>
  <td>
    <button class="action-btn view-btn" data-order="${order._id || order.id}">ÿπÿ±ÿ∂</button>
    <button class="action-btn assign-btn" data-order="${order._id || order.id}">ÿ™ÿπŸäŸäŸÜ ÿ•ŸÑŸâ ŸÖŸÉÿ™ÿ®ÿ©</button>
    <button class="action-btn delete-btn" data-order="${order._id || order.id}">ÿ≠ÿ∞ŸÅ</button>
  </td>
`;

// After appending the row to tbody, call:
addAssignButtonToOrders();
                tbody.appendChild(tr);
            });
            
            // Add event listeners for status changes
            document.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', function() {
                    updateOrderStatus(this.dataset.order, this.value);
                });
            });
            
            // Add event listeners for view buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    viewOrderDetails(this.dataset.order);
                });
            });
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteOrder(this.dataset.order);
                });
            });
        }
        
        // Update order status
        function updateOrderStatus(orderId, status) {
            fetch(`${API_BASE}/api/orders/${orderId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({ status })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.message) {
                    showAlert('ordersAlert', 'success', 'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑ŸÑÿ® ÿ®ŸÜÿ¨ÿßÿ≠');
                    loadOrders(); // Reload orders to reflect changes
                } else {
                    showAlert('ordersAlert', 'error', data.message || 'ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑ŸÑÿ®');
                }
            })
            .catch(error => {
                showAlert('ordersAlert', 'error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ');
                console.error('Error updating order status:', error);
            });
        }
        
        // View order details
        function viewOrderDetails(orderId) {
            fetch(`${API_BASE}/api/orders/${orderId}`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(order => {
                currentOrder = order;
                const modal = document.getElementById('orderDetailsModal');
                const content = document.getElementById('orderDetailsContent');
                const viewImageBtn = document.getElementById('viewImageBtn');
                const viewLocationBtn = document.getElementById('viewLocationBtn');
                const imagePreview = document.getElementById('imagePreview');
                
                if (!modal || !content) return;
                
                // Format date
                const orderDate = new Date(order.createdAt).toLocaleDateString('ar-MA');
                
                // File link if exists
                let fileLink = 'ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖŸÑŸÅ';
                if (order.suppliesList) {
                    const isFullUrl = order.suppliesList.startsWith('http');
                    const fileUrl = isFullUrl ? order.suppliesList : `${API_BASE}/uploads/${order.suppliesList}`;
                    fileLink = `<a href="${fileUrl}" target="_blank" class="file-link">ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÑŸÅ ÿπŸÑŸâ ImgBB</a>`;
                    
                    // Set up view image button
                    viewImageBtn.style.display = 'inline-block';
                    viewImageBtn.onclick = function() {
                        window.open(fileUrl, '_blank');
                    };
                    
                    // Show image preview if it's an image
                    if (fileUrl.match(/\.(jpeg|jpg|png|gif)$/i)) {
                        imagePreview.src = fileUrl;
                        imagePreview.style.display = 'block';
                    } else {
                        imagePreview.style.display = 'none';
                    }
                } else {
                    viewImageBtn.style.display = 'none';
                    imagePreview.style.display = 'none';
                }
                
                // Location link if exists
                let locationLink = 'ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±';
                if (order.location && order.location.coordinates) {
                    const [lng, lat] = order.location.coordinates;
                    const mapsUrl = `https://www.google.com/maps?q=${lat},${lng}`;
                    locationLink = `<a href="${mapsUrl}" target="_blank" class="map-link">ÿπÿ±ÿ∂ ÿßŸÑŸÖŸàŸÇÿπ ÿπŸÑŸâ ÿÆÿ±ÿßÿ¶ÿ∑ ÿ¨Ÿàÿ¨ŸÑ</a>`;
                    
                    // Set up view location button
                    viewLocationBtn.style.display = 'inline-block';
                    viewLocationBtn.onclick = function() {
                        window.open(mapsUrl, '_blank');
                    };
                } else {
                    viewLocationBtn.style.display = 'none';
                }
                
                content.innerHTML = `
  <div class="detail-row">
    <div class="detail-label">ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®:</div>
    <div class="detail-value">${order.orderNumber || order._id || order.id || 'N/A'}</div>
  </div>
                    <div class="detail-row">
                        <div class="detail-label">ÿßÿ≥ŸÖ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±:</div>
                        <div class="detail-value">${order.parentName || 'ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Ÿáÿßÿ™ŸÅ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±:</div>
                        <div class="detail-value">${order.phone || 'ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">ÿßÿ≥ŸÖ ÿßŸÑÿ™ŸÑŸÖŸäÿ∞:</div>
                        <div class="detail-value">${order.studentName || 'ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿØÿ±ÿßÿ≥Ÿä:</div>
                        <div class="detail-value">${order.grade || 'ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">ÿßŸÑÿ≠ÿßŸÑÿ©:</div>
                        <div class="detail-value">
                            <span class="status-badge ${getStatusClass(order.status)}">${getStatusText(order.status)}</span>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ∑ŸÑÿ®:</div>
                        <div class="detail-value">${orderDate}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÑŸàÿßÿ≤ŸÖ:</div>
                        <div class="detail-value">${fileLink}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">ÿßŸÑŸÖŸàŸÇÿπ:</div>
                        <div class="detail-value">${locationLink}</div>
                    </div>
                `;
                
                modal.classList.add('active');
            })
            .catch(error => {
                showAlert('ordersAlert', 'error', 'ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ∑ŸÑÿ®');
                console.error('Error loading order details:', error);
            });
        }
        
        // Delete order
        function deleteOrder(orderId) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ∑ŸÑÿ®ÿü')) return;
            
            fetch(`${API_BASE}/api/orders/${orderId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.message) {
                    showAlert('ordersAlert', 'success', 'ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∑ŸÑÿ® ÿ®ŸÜÿ¨ÿßÿ≠');
                    loadOrders(); // Reload orders to reflect changes
                } else {
                    showAlert('ordersAlert', 'error', data.message || 'ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∑ŸÑÿ®');
                }
            })
            .catch(error => {
                showAlert('ordersAlert', 'error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ');
                console.error('Error deleting order:', error);
            });
        }
        
        // Helper function to get status class
        function getStatusClass(status) {
            switch(status) {
                case 'pending': return 'status-pending';
                case 'confirmed': return 'status-confirmed';
                case 'processing': return 'status-processing';
                case 'delivered': return 'status-delivered';
                default: return 'status-pending';
            }
        }
        
        // Helper function to get status text
        function getStatusText(status) {
            switch(status) {
                case 'pending': return 'ŸÇŸäÿØ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©';
                case 'confirmed': return 'ÿ™ŸÖ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ';
                case 'processing': return 'ŸÇŸäÿØ ÿßŸÑÿ™ÿ¨ŸáŸäÿ≤';
                case 'delivered': return 'ÿ™ŸÖ ÿßŸÑÿ™ŸàÿµŸäŸÑ';
                default: return 'ŸÇŸäÿØ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©';
            }
        }
        
        // Show alert message
        function showAlert(containerId, type, message) {
            const alert = document.getElementById(containerId);
            if (!alert) return;
            
            alert.textContent = message;
            alert.classList.remove('hidden', 'alert-error', 'alert-success');
            alert.classList.add(`alert-${type}`);
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                alert.classList.add('hidden');
            }, 5000);
        }
        
        // Close modal
        document.getElementById('closeModalBtn').addEventListener('click', function() {
            document.getElementById('orderDetailsModal').classList.remove('active');
        });
        
        // Close modal when clicking outside
        document.getElementById('orderDetailsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
        
        // Initialize the app
        window.addEventListener('load', function() {
            // Make sure the modal is hidden on page load
            document.getElementById('orderDetailsModal').classList.remove('active');
        });
        // Add after the existing JavaScript code
let allOrders = [];

function applyFilters() {
    const statusFilter = document.getElementById('statusFilter').value;
    const searchFilter = document.getElementById('searchInput').value.toLowerCase();
    
    let filteredOrders = allOrders;
    
    if (statusFilter) {
        filteredOrders = filteredOrders.filter(order => order.status === statusFilter);
    }
    
    if (searchFilter) {
        filteredOrders = filteredOrders.filter(order => 
            order.parentName.toLowerCase().includes(searchFilter) || 
            order.studentName.toLowerCase().includes(searchFilter)
        );
    }
    
    renderOrdersTable(filteredOrders);
    updateStats(allOrders); // Add this line to update stats with all orders (not filtered)
}
document.getElementById('applyFilters').addEventListener('click', applyFilters);
document.getElementById('statusFilter').addEventListener('change', applyFilters);
document.getElementById('searchInput').addEventListener('input', applyFilters);

// Add to your existing JavaScript
let map, marker;
let libraries = [];
let currentEditingLibraryId = null;
let currentOrderIdForAssign = null;

// Toggle library creation section
function toggleLibrarySection() {
    const librarySection = document.getElementById('libraryCreation');
    librarySection.style.display = librarySection.style.display === 'none' ? 'block' : 'none';
    
    if (librarySection.style.display === 'block') {
        initMap();
        loadLibraries();
    }
}

// Initialize map
function initMap() {
  map = L.map('map').setView([35.5762, -5.3684], 13); // Tetouan coordinates
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  
  map.on('click', function(e) {
    if (marker) {
      map.removeLayer(marker);
    }
    marker = L.marker(e.latlng).addTo(map);
  });
}

function openLibraryModal() {
  document.getElementById('libraryModal').style.display = 'block';
  initMap();
  loadLibraries();
  resetLibraryForm();
}

// Close library modal
function closeLibraryModal() {
  document.getElementById('libraryModal').style.display = 'none';
}

// Load libraries
function loadLibraries() {
  fetch(`${API_BASE}/api/libraries`, {
    headers: {
      'Authorization': `Bearer ${authToken}`
    }
  })
  .then(response => response.json())
  .then(data => {
    libraries = data;
    renderLibraries();
  })
  .catch(error => console.error('Error loading libraries:', error));
}

// Render libraries list
function renderLibraries() {
  const container = document.getElementById('librariesContainer');
  container.innerHTML = '';
  
  libraries.forEach(library => {
    const libElement = document.createElement('div');
    libElement.style.background = 'white';
    libElement.style.padding = '15px';
    libElement.style.margin = '10px 0';
    libElement.style.borderRadius = '5px';
    libElement.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
    
    libElement.innerHTML = `
      <strong>${library.name}</strong> - ${library.phone}
      <div>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${library.username}</div>
      <div>ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±: ${library.plainPassword}</div>
      <div style="margin-top: 10px;">
        <button onclick="editLibrary('${library._id}')" style="background: var(--secondary); color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-right: 5px; cursor: pointer;">
          ÿ™ÿπÿØŸäŸÑ
        </button>
        <button onclick="deleteLibrary('${library._id}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
          ÿ≠ÿ∞ŸÅ
        </button>
      </div>
    `;
    
    container.appendChild(libElement);
  });
}

// Edit library
function editLibrary(libraryId) {
  const library = libraries.find(lib => lib._id === libraryId);
  if (library) {
    currentEditingLibraryId = libraryId;
    document.getElementById('libraryName').value = library.name;
    document.getElementById('libraryPhone').value = library.phone;
    document.getElementById('libraryUsername').value = library.username;
    document.getElementById('libraryPassword').value = library.plainPassword;
    
    // Remove the current marker if exists
    if (marker) {
      map.removeLayer(marker);
    }
    // Add marker at library's location
    marker = L.marker([library.location.coordinates[1], library.location.coordinates[0]]).addTo(map);
    map.setView([library.location.coordinates[1], library.location.coordinates[0]], 13);
  }
}

// Delete library
function deleteLibrary(libraryId) {
  if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÖŸÉÿ™ÿ®ÿ©ÿü')) {
    fetch(`${API_BASE}/api/libraries/${libraryId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${authToken}`
      }
    })
    .then(response => response.json())
    .then(data => {
      alert('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÉÿ™ÿ®ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
      loadLibraries();
    })
    .catch(error => console.error('Error deleting library:', error));
  }
}
// Create new library
document.getElementById('saveLibraryBtn').addEventListener('click', function() {
    const name = document.getElementById('libraryName').value;
    const phone = document.getElementById('libraryPhone').value;
    const username = document.getElementById('libraryUsername').value;
    const password = document.getElementById('libraryPassword').value;
    
    if (!name || !phone || !username || !password || !marker) {
        alert('Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ Ÿàÿ™ÿ≠ÿØŸäÿØ ŸÖŸàŸÇÿπ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©');
        return;
    }
    
    const latlng = marker.getLatLng();
    
    fetch(`${API_BASE}/api/libraries`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify({
            name,
            phone,
            username,
            password,
            latitude: latlng.lat,
            longitude: latlng.lng
        })
    })
    .then(response => response.json())
    .then(data => {
        alert(`ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖŸÉÿ™ÿ®ÿ© ÿ®ŸÜÿ¨ÿßÿ≠. ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØÿÆŸàŸÑ: ${data.credentials.username} / ${data.credentials.password}`);
        loadLibraries();
    })
    .catch(error => console.error('Error creating library:', error));
});

// Save library (create or update)
document.getElementById('saveLibraryBtn').addEventListener('click', function() {
  const name = document.getElementById('libraryName').value;
  const phone = document.getElementById('libraryPhone').value;
  const username = document.getElementById('libraryUsername').value;
  const password = document.getElementById('libraryPassword').value;
  
  if (!name || !phone || !username || !password || !marker) {
    alert('Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ Ÿàÿ™ÿ≠ÿØŸäÿØ ŸÖŸàŸÇÿπ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©');
    return;
  }
  
  const latlng = marker.getLatLng();
  
  const url = currentEditingLibraryId ? 
    `${API_BASE}/api/libraries/${currentEditingLibraryId}` : 
    `${API_BASE}/api/libraries`;
  
  const method = currentEditingLibraryId ? 'PUT' : 'POST';
  
  fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${authToken}`
    },
    body: JSON.stringify({
      name,
      phone,
      username,
      password,
      latitude: latlng.lat,
      longitude: latlng.lng
    })
  })
  .then(response => response.json())
  .then(data => {
    alert(currentEditingLibraryId ? 'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÉÿ™ÿ®ÿ© ÿ®ŸÜÿ¨ÿßÿ≠' : 'ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖŸÉÿ™ÿ®ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
    loadLibraries();
    resetLibraryForm();
  })
  .catch(error => console.error('Error saving library:', error));
});

document.querySelectorAll('.assign-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    openAssignOrderModal(this.dataset.order);
  });
});

// Reset library form
function resetLibraryForm() {
  currentEditingLibraryId = null;
  document.getElementById('libraryName').value = '';
  document.getElementById('libraryPhone').value = '';
  document.getElementById('libraryUsername').value = '';
  document.getElementById('libraryPassword').value = '';
  if (marker) {
    map.removeLayer(marker);
    marker = null;
  }
  // Reset map view to Tetouan
  map.setView([35.5762, -5.3684], 13);
}

// Open assign order modal
function openAssignOrderModal(orderId) {
  currentOrderIdForAssign = orderId;
  const order = allOrders.find(o => o._id === orderId);
  document.getElementById('assignOrderModal').style.display = 'block';
  document.getElementById('assignOrderNumber').textContent = order.orderNumber || order._id;
  loadLibrariesForAssign();
}

// Close assign order modal
function closeAssignOrderModal() {
  document.getElementById('assignOrderModal').style.display = 'none';
}

// Load libraries for assignment
function loadLibrariesForAssign() {
  fetch(`${API_BASE}/api/libraries`, {
    headers: {
      'Authorization': `Bearer ${authToken}`
    }
  })
  .then(response => response.json())
  .then(libraries => {
    renderLibrariesForAssign(libraries);
  })
  .catch(error => console.error('Error loading libraries for assign:', error));
}

// Render libraries for assignment
function renderLibrariesForAssign(libraries) {
  const container = document.getElementById('librariesForAssignContainer');
  container.innerHTML = '';
  
  if (libraries.length === 0) {
    container.innerHTML = '<p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÉÿ™ÿ®ÿßÿ™</p>';
    return;
  }
  
  libraries.forEach(library => {
    const libElement = document.createElement('div');
    libElement.style.background = 'white';
    libElement.style.padding = '15px';
    libElement.style.margin = '10px 0';
    libElement.style.borderRadius = '5px';
    libElement.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
    libElement.style.cursor = 'pointer';
    
    libElement.innerHTML = `
      <strong>${library.name}</strong> - ${library.phone}
      <div>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${library.username}</div>
    `;
    
    libElement.addEventListener('click', function() {
      assignOrderToLibrary(library._id);
    });
    
    container.appendChild(libElement);
  });
}

// Assign order to library
function assignOrderToLibrary(libraryId) {
  fetch(`${API_BASE}/api/orders/${currentOrderIdForAssign}/assign`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${authToken}`
    },
    body: JSON.stringify({ libraryId })
  })
  .then(response => response.json())
  .then(data => {
    alert('ÿ™ŸÖ ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ∑ŸÑÿ® ÿ•ŸÑŸâ ÿßŸÑŸÖŸÉÿ™ÿ®ÿ©');
    closeAssignOrderModal();
    loadOrders(); // Reload orders to update the status
  })
  .catch(error => {
    alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ∑ŸÑÿ®');
    console.error('Error assigning order:', error);
  });
}

// Add event listeners for modals
document.querySelectorAll('.modal .close').forEach(closeBtn => {
  closeBtn.addEventListener('click', function() {
    this.closest('.modal').style.display = 'none';
  });
});
document.getElementById('manageLibrariesBtn').addEventListener('click', openLibraryModal);
function addAssignButtonToOrders() {
  // Add event listeners for assign buttons
  document.querySelectorAll('.assign-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      openAssignOrderModal(this.dataset.order);
    });
  });
}
// Close modals when clicking outside
window.addEventListener('click', function(event) {
  if (event.target.classList.contains('modal')) {
    event.target.style.display = 'none';
  }
});

    </script>
</body>
</html>